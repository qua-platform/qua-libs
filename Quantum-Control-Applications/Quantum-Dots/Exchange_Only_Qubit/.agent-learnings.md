# Agent Learnings - Exchange Only Qubit Integration

> **Purpose**: This file is a shared knowledge base for agents working on this integration.
> Update this file as you discover patterns, gotchas, decisions, or useful context.
> Future agents should read this before starting work.

---

## Codebase Context

### Repository Structure
- **qua-libs** (this repo): Customer-facing examples for QUA DSL
- **py-qua-tools** (sibling repo): Reusable Python tools library
- Both repos have separate git histories - changes here should not affect py-qua-tools

### Key Files in Exchange_Only_Qubit
| File | Purpose | Modify? |
|------|---------|---------|
| `configuration.py` | OPX config + local VoltageGateSequence copy | YES - remove class |
| `macros.py` | QUA macros (lock_in_macro) + Python helpers | NO - keep as-is |
| `qdac2_driver.py` | QDAC2 instrument driver | YES - add function |
| `snr_utils.py` | SNR calculation for singlet-triplet | NO - unique code |
| `00a-09_*.py` | Experiment scripts | SOME - fix API calls |

### DSL Note
The QUA DSL code inside `with program() as prog:` blocks is validated against real hardware.
**DO NOT modify QUA DSL code** - only modify Python wrapper code and imports.

---

## Decisions Made

### Why alias instead of rename?
```python
OPX_virtual_gate_sequence = VoltageGateSequence  # backward compat alias
```
- Experiment files import from `configuration.py`
- Changing all files to use new name is higher risk
- Alias allows gradual migration

### Why max_amplitude instead of duration?
- py-qua-tools `VoltageGateSequence.add_compensation_pulse()` changed API
- Old: `add_compensation_pulse(duration=5000)` - user specifies duration
- New: `add_compensation_pulse(max_amplitude=0.49)` - auto-calculates duration
- The `duration` parameter still works but is deprecated (shows warning)

---

## Patterns to Follow

### Commit Message Format
```
type: short description

- Detail 1
- Detail 2
```
Types: `feat`, `fix`, `refactor`, `docs`, `test`

### README Structure (from Singlet_Triplet_Qubit)
1. Title with qubit type
2. Experimental setup section with context
3. Numbered list of scripts with descriptions
4. Use Cases section (if applicable)

### Test File Location
Tests go in: `Quantum-Control-Applications/Quantum-Dots/Exchange_Only_Qubit/tests/`
(Create `tests/` folder if it doesn't exist)

---

## Gotchas & Pitfalls

### Import Order Matters
In `configuration.py`, the import must come BEFORE any code that uses it:
```python
# Correct order:
from qualang_tools.voltage_gates import VoltageGateSequence
OPX_virtual_gate_sequence = VoltageGateSequence  # alias

# NOT after config dict
```

### QDAC2 Driver Differences
Exchange_Only_Qubit version vs Single_Spin_EDSR version:
- EOQ: `baud_rate` set after `open_resource()` in Ethernet branch
- EDSR: `baud_rate` set after `write_termination` 
- EDSR has extra `set_qdac_voltage()` function
- When consolidating, use EDSR structure but preserve EOQ's baud_rate placement for Ethernet

### Files That DON'T Use VoltageGateSequence
Verified by grep - these files don't need API updates:
- `00a_raw_adc_traces.py` - no sequence
- `00b_repeated_readout_demod.py` - no sequence
- `00c_repeated_readout_ADC_trace.py` - no sequence
- `01_sensor_gate_qdac2.py` - no sequence
- `02_charge_stability_qdac2.py` - no sequence
- `03_spiral_charge_stability.py` - uses `spiral_order`, not VoltageGateSequence
- `05_T1_at_readout.py` - no sequence

---

## Agent Activity Log

### [Date: 2026-01-23] - Initial Setup
- Agent: Lead Agent
- Task: Create branch
- Notes: Created `feature/exchange-only-qubit` branch from main. Exchange_Only_Qubit folder is untracked.

### [Date: 2026-01-23] - Agent 1 Complete
- Agent: Agent 1 (Code)
- Task: Code refactoring
- Notes: 
  - Removed local `OPX_virtual_gate_sequence` class from configuration.py (235 lines removed)
  - Added import from `qualang_tools.voltage_gates.VoltageGateSequence` with backward-compatible alias
  - Updated ALL experiment files using `add_compensation_pulse` API:
    - 04_PSB_spectroscopy.py (1 call)
    - 05_T1_at_readout.py (1 call)
    - 06_SNR_optimization.py (1 call)
    - 07a_initialization_search.py (2 calls)
    - 07b_init_search_duration.py (2 calls)
    - 08_power_time_rabi_like.py (1 call)
    - 09_fingerprint_rabi_like.py (1 call)
  - Updated qdac2_driver.py: added `close()` method and `set_qdac_voltage()` function
  - Note: More files needed updates than originally listed in the plan (05_, 07b_, 09_ were discovered via grep)

### [Date: 2026-01-23] - Agent 2 Complete
- Agent: Agent 2 (Docs/Tests)
- Task: Documentation & tests
- Notes:
  - Created `README.md` following pattern from Singlet_Triplet_Qubit and Single_Spin_EDSR
    - Includes experimental setup context
    - Documents all 10 experiment scripts (00a-09) with descriptions
    - Organized by category (Raw ADC, Sensor Gate, Charge Stability, PSB, T1, SNR, Initialization, Rabi-like)
  - Created `tests/` directory with `__init__.py`
  - Created `tests/test_snr_utils.py` with 8 pure Python tests:
    - `test_snr_map_crude_bimodal()` - verifies SNR calculation on synthetic bimodal data
    - `test_snr_map_crude_shape()` - verifies output shape
    - `test_snr_calculation()` - unit test for SNR formula
    - `test_double_gaussian_function()` - unit test for double gaussian helper
    - `test_double_gaussian_fitting()` - verifies function can be evaluated with curve_fit
    - `test_split_singlet_triplet_distributions()` - verifies distribution splitting
    - `test_guess_individual_means_stds()` - verifies mean/std estimation
    - `test_snr_map_double_gaussian_shape()` - verifies shape (fitting may fail with random data)
  - Created `tests/test_macros.py` with 11 pure Python tests:
    - `test_spiral_order_center_is_zero()` - center starts at 0
    - `test_spiral_order_unique_indices()` - all indices 0 to NÂ²-1 appear once
    - `test_spiral_order_odd_size()` - works with odd sizes
    - `test_spiral_order_even_size_converted_to_odd()` - even sizes converted to odd
    - `test_spiral_order_spiral_pattern()` - verifies spiral pattern
    - `test_get_filtered_voltage_high_pass()` - verifies DC component removal
    - `test_get_filtered_voltage_shape()` - verifies correct output shape
    - `test_get_filtered_voltage_step_response()` - verifies filter responds to steps
    - `test_round_to_fixed_precision()` - verifies fixed-point rounding
    - `test_round_to_fixed_reduces_precision()` - verifies precision reduction
    - `test_round_to_fixed_zero()` and `test_round_to_fixed_negative()` - edge cases
  - All tests use pytest and are pure Python (no QUA/hardware required)
  - Tests use numpy.random.seed(42) for reproducibility

---

## Open Questions

1. ~~Should we update `07b_init_search_duration.py`?~~ **RESOLVED**: Yes, it uses the sequence with 2 calls to `add_compensation_pulse`. Updated.
2. ~~Should `09_fingerprint_rabi_like.py` API be updated?~~ **RESOLVED**: Yes, it uses the sequence. Updated.
3. ~~Test file location - should tests be in `tests/` subfolder or alongside scripts?~~ **RESOLVED**: Created `tests/` subfolder following standard Python project structure.

---

## Deployment Verification Log

### [Date: 2026-01-23] - Pre-Commit Verification

**Agent 1 (Test Runner)**:
- pytest not installed in environment - tests cannot be run locally
- Test files exist and are syntactically valid:
  - `tests/test_snr_utils.py` (8 tests defined)
  - `tests/test_macros.py` (11 tests defined)
- Tests are pure Python and will run when pytest is available

**Agent 2 (Code Verifier)**:
- configuration.py import chain: VERIFIED
  - Line 3: `from qualang_tools.voltage_gates import VoltageGateSequence`
  - Line 7: `OPX_virtual_gate_sequence = VoltageGateSequence`
- Experiment files with max_amplitude API: VERIFIED (9 calls in 7 files)
  - 04_PSB_spectroscopy.py (line 83)
  - 05_T1_at_readout.py (line 59)
  - 06_SNR_optimization.py (line 69)
  - 07a_initialization_search.py (lines 66, 87)
  - 07b_init_search_duration.py (lines 66, 87)
  - 08_power_time_rabi_like.py (line 76)
  - 09_fingerprint_rabi_like.py (line 79)
- qdac2_driver.py: VERIFIED - `set_qdac_voltage` function at line 106
- File count: 24 files (includes tests/, README, .agent-learnings.md)

**Status**: All verifications passed. Ready for commit.

---

## Resources

- [VoltageGateSequence source](../../../py-qua-tools/qualang_tools/voltage_gates/voltage_gate_sequence.py)
- [Existing tests for VoltageGateSequence](../../../py-qua-tools/tests_against_server/test_voltage_gate_sequence.py)
- [Singlet_Triplet README](../Singlet_Triplet_Qubit/README.md) - template for documentation
- [Single_Spin_EDSR README](../Single_Spin_EDSR/README.md) - another template
